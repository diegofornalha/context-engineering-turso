#!/usr/bin/env python3
"""
Turso Agent CLI - VersÃ£o com Dados Reais
Usa as ferramentas MCP do ambiente atual
"""

import asyncio
import sys
import os
from pathlib import Path
from datetime import datetime
import argparse

# Adicionar diretÃ³rio ao path
sys.path.insert(0, str(Path(__file__).parent))

from config.turso_settings import TursoSettings

class TursoAgentReal:
    """Turso Agent que usa dados reais via MCP"""
    
    def __init__(self):
        self.settings = TursoSettings()
        
    async def performance(self, table=None):
        """AnÃ¡lise de performance com dados REAIS"""
        print("âš¡ ANÃLISE DE PERFORMANCE TURSO (DADOS REAIS)")
        print("="*60)
        
        print(f"\nğŸ“Š Database: {self.settings.default_database}")
        
        # Esta versÃ£o assume que as ferramentas MCP estÃ£o disponÃ­veis no ambiente
        print("\nğŸ’¡ Para anÃ¡lise com dados reais, use no Claude Code ou Cursor:")
        print("\n1. Execute list_databases para ver bancos disponÃ­veis")
        print("2. Use describe_table para analisar estrutura")
        print("3. Execute queries com execute_read_only_query")
        
        if table:
            print(f"\nğŸ¯ AnÃ¡lise sugerida para tabela '{table}':")
            print(f"   â€¢ PRAGMA index_list('{table}') - Ver Ã­ndices")
            print(f"   â€¢ SELECT COUNT(*) FROM {table} - Contar registros")
            print(f"   â€¢ EXPLAIN QUERY PLAN SELECT * FROM {table} - Analisar plano")
        
        print("\nâœ… RECOMENDAÃ‡Ã•ES GERAIS:")
        print("â€¢ Criar Ã­ndices em colunas de WHERE/JOIN")
        print("â€¢ Executar VACUUM e ANALYZE regularmente")
        print("â€¢ Usar EXPLAIN QUERY PLAN em queries lentas")
        
    async def query_guide(self, query=None):
        """Guia para executar queries reais"""
        print("ğŸ’» GUIA DE QUERIES TURSO")
        print("="*60)
        
        if query:
            print(f"\nğŸ” Sua query: {query}")
            print("\nğŸ“‹ Para executar no Claude Code/Cursor:")
            print(f"   mcp_turso_execute_read_only_query(")
            print(f'       query="{query}",')
            print(f'       database="{self.settings.default_database}"')
            print(f"   )")
        else:
            print("\nğŸ“Š Queries Ãºteis para anÃ¡lise:")
            print("\n1. Ver todas as tabelas:")
            print('   mcp_turso_list_tables()')
            
            print("\n2. Estrutura de uma tabela:")
            print('   mcp_turso_describe_table(table_name="nome_tabela")')
            
            print("\n3. Contar registros:")
            print('   mcp_turso_execute_read_only_query(')
            print('       query="SELECT COUNT(*) FROM tabela"')
            print('   )')
            
            print("\n4. Ver Ã­ndices:")
            print('   mcp_turso_execute_read_only_query(')
            print('       query="PRAGMA index_list(\'tabela\')"')
            print('   )')
            
    async def security_check(self):
        """Checklist de seguranÃ§a para verificaÃ§Ã£o real"""
        print("ğŸ›¡ï¸ CHECKLIST DE SEGURANÃ‡A TURSO")
        print("="*60)
        
        print("\nğŸ“‹ VerificaÃ§Ãµes recomendadas com MCP:")
        
        print("\n1. Listar todos os bancos:")
        print("   mcp_turso_list_databases()")
        print("   â†’ Verifique se hÃ¡ bancos nÃ£o autorizados")
        
        print("\n2. Verificar tabelas sensÃ­veis:")
        print("   mcp_turso_list_tables()")
        print("   â†’ Procure por: users, auth, tokens, passwords")
        
        print("\n3. Analisar estrutura de tabelas sensÃ­veis:")
        print("   mcp_turso_describe_table(table_name='users')")
        print("   â†’ Verifique se campos sensÃ­veis estÃ£o expostos")
        
        print("\n4. Verificar dados sensÃ­veis:")
        print("   SELECT name FROM pragma_table_info('users')")
        print("   WHERE name LIKE '%password%' OR name LIKE '%token%'")
        
        print("\nâœ… Checklist de SeguranÃ§a:")
        print("â˜ Tokens de API seguros e rotacionados")
        print("â˜ Campos sensÃ­veis criptografados")
        print("â˜ Acesso restrito a bancos de produÃ§Ã£o")
        print("â˜ Audit logging habilitado")
        print("â˜ Backups automÃ¡ticos configurados")
        
    async def optimize_guide(self, target=None):
        """Guia de otimizaÃ§Ã£o com comandos reais"""
        print("ğŸ“ˆ GUIA DE OTIMIZAÃ‡ÃƒO TURSO")
        print("="*60)
        
        if target:
            print(f"\nğŸ¯ Otimizando: {target}")
            
        print("\nğŸ“‹ Comandos de otimizaÃ§Ã£o via MCP:")
        
        print("\n1. AnÃ¡lise de performance:")
        print("   # Ver tabelas grandes")
        print("   SELECT name, SUM(pgsize) as size")
        print("   FROM dbstat GROUP BY name")
        print("   ORDER BY size DESC LIMIT 10")
        
        print("\n2. Verificar Ã­ndices:")
        print("   # Listar todos os Ã­ndices")
        print("   SELECT name, tbl_name FROM sqlite_master")
        print("   WHERE type = 'index'")
        
        print("\n3. EstatÃ­sticas de uso:")
        print("   # Analisar queries lentas")
        print("   EXPLAIN QUERY PLAN")
        print("   SELECT ... (sua query)")
        
        print("\n4. ManutenÃ§Ã£o:")
        print("   # Via Turso CLI")
        print("   turso db shell <database> 'VACUUM;'")
        print("   turso db shell <database> 'ANALYZE;'")
        
        print("\nğŸ’¡ Dica: Use estas queries com mcp_turso_execute_read_only_query")
        
    async def tables_analysis(self):
        """AnÃ¡lise detalhada de tabelas"""
        print("ğŸ“‹ ANÃLISE DE TABELAS TURSO")
        print("="*60)
        
        print("\nğŸ” Comandos para anÃ¡lise de tabelas:")
        
        print("\n1. Listar todas as tabelas:")
        print("   tables = mcp_turso_list_tables()")
        
        print("\n2. Para cada tabela importante:")
        print("   # Estrutura")
        print("   mcp_turso_describe_table(table_name='tabela')")
        print("\n   # Tamanho")
        print("   SELECT COUNT(*) FROM tabela")
        print("\n   # Ãndices")
        print("   PRAGMA index_list('tabela')")
        
        print("\n3. AnÃ¡lise de dados:")
        print("   # DistribuiÃ§Ã£o")
        print("   SELECT column, COUNT(*) as freq")
        print("   FROM tabela GROUP BY column")
        print("   ORDER BY freq DESC LIMIT 10")
        
        print("\nğŸ“Š MÃ©tricas importantes:")
        print("â€¢ NÃºmero total de tabelas")
        print("â€¢ Tamanho de cada tabela")
        print("â€¢ Ãndices existentes")
        print("â€¢ Colunas mais usadas em WHERE")
        
    async def check(self):
        """Status e instruÃ§Ãµes de uso"""
        print("ğŸš€ TURSO AGENT - MODO DADOS REAIS")
        print("="*60)
        
        print(f"\nğŸ“Š ConfiguraÃ§Ã£o:")
        print(f"  â€¢ Database: {self.settings.default_database}")
        print(f"  â€¢ Organization: {self.settings.turso_organization}")
        print(f"  â€¢ Token: {'âœ… Configurado' if self.settings.turso_api_token else 'âŒ Faltando'}")
        
        print("\nğŸ”Œ Como usar com dados reais:")
        print("\n1. No Claude Code ou Cursor, as ferramentas MCP estÃ£o disponÃ­veis:")
        print("   â€¢ mcp_turso_list_databases()")
        print("   â€¢ mcp_turso_execute_read_only_query()")
        print("   â€¢ mcp_turso_describe_table()")
        print("   â€¢ etc...")
        
        print("\n2. Este CLI fornece:")
        print("   â€¢ Guias de queries otimizadas")
        print("   â€¢ Checklists de seguranÃ§a")
        print("   â€¢ Comandos prontos para copiar/colar")
        print("   â€¢ AnÃ¡lises especializadas")
        
        print("\nğŸ’¡ Exemplo de uso integrado:")
        print("   1. Use 'turso_real query' para ver queries sugeridas")
        print("   2. Copie e execute no Claude Code/Cursor")
        print("   3. Analise os resultados com 'turso_real performance'")

async def main():
    parser = argparse.ArgumentParser(
        description='Turso Agent Real - Guia para anÃ¡lise com dados reais'
    )
    
    parser.add_argument('command', nargs='?', default='help',
                       help='performance, query, security, optimize, tables, check')
    parser.add_argument('args', nargs='*', help='Argumentos do comando')
    
    args = parser.parse_args()
    
    agent = TursoAgentReal()
    
    command = args.command.lower()
    command_args = ' '.join(args.args) if args.args else None
    
    try:
        if command in ['performance', 'perf', 'p']:
            await agent.performance(command_args)
            
        elif command in ['query', 'q']:
            await agent.query_guide(command_args)
            
        elif command in ['security', 'sec', 's']:
            await agent.security_check()
            
        elif command in ['optimize', 'opt', 'o']:
            await agent.optimize_guide(command_args)
            
        elif command in ['tables', 't']:
            await agent.tables_analysis()
            
        elif command in ['check', 'c']:
            await agent.check()
            
        elif command in ['help', 'h']:
            print("ğŸ¯ TURSO AGENT REAL - Comandos")
            print("="*50)
            print("\nğŸ“Š performance [table]  - AnÃ¡lise com guias reais")
            print("ğŸ’» query [sql]         - Guia de queries")
            print("ğŸ›¡ï¸  security           - Checklist de seguranÃ§a")
            print("ğŸ“ˆ optimize [target]   - Guia de otimizaÃ§Ã£o")
            print("ğŸ“‹ tables              - AnÃ¡lise de tabelas")
            print("ğŸš€ check               - Status e instruÃ§Ãµes")
            print("\nExemplos:")
            print("  turso_real query")
            print("  turso_real performance users")
            print("  turso_real security")
            
        else:
            print(f"âŒ Comando desconhecido: {command}")
            
    except Exception as e:
        print(f"âŒ Erro: {str(e)}")

if __name__ == "__main__":
    asyncio.run(main())